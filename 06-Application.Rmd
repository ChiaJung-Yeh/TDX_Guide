```{r setup4, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(sf)
library(ggplot2)
library(ggsflabel)
library(ggspatial)
library(RColorBrewer)
library(knitr)
library(kableExtra)
library(TDX)
library(DT)
library(tmap)

windowsFonts(A=windowsFont("微軟正黑體"))
tmap_mode("view")

client_id=read.csv("./key.txt", header=F)[1,2]
client_secret=read.csv("./key.txt", header=F)[2,2]
access_token=get_token(client_id, client_secret)
```

# **運輸資料應用**
本章節主要示範運輸資料於實務場域中的應用。


## 計算公車站點間旅行距離
本節透過 TDX 公車站牌與路線圖資，建立演算法計算各站牌的累積里程，進而計算站點間旅行距離[**（簡報）**](https://github.com/ChiaJung-Yeh/TDX_Guide/raw/master/slides/%E8%A8%88%E7%AE%97%E5%85%AC%E8%BB%8A%E7%AB%99%E9%BB%9E%E9%96%93%E6%97%85%E8%A1%8C%E8%B7%9D%E9%9B%A2.pptx)。


### 目的
站點間距離可用以反映任兩站點間公車行駛的實際里程，該數據可進一步與 TDX 歷史資料中的行駛時間（[`Bus_TravelTime()`](#公車站間旅行時間資料)）或公車歷史動態資料（[`Bus_RealTime()`](#公車動態)）對應，以計算各區間的平均速度，尋找公車各時段阻塞的區間，進而提出相對應的改善方式。在 [GTFS](https://gtfs.org/) 格式中，里程資訊為必備欄位，如是可依據各站點的累積里程推算任兩站點間的距離。然而 TDX 的公車站點資料（Bus_StopOfRoute）中並未提供該數據，進而無法計算站點間距離。其一解決方式是將各站點的經緯度輸入至地圖路徑規劃的 API 中，尋找公共運輸的最佳路徑，然而此一方法並不能確保所選擇的運具為特定公車路線；若以私有運具的路徑概似之，其缺點乃公車路線並不確保是最短距離，乃因受限於公車營運之限制或提升服務可及性，站點間距離可能大於兩點間的最短路徑長度。此外，使用地圖 API 曠日廢時或所需費用甚高，因此實務上可能並不合適。綜上所述，本節將建構一套演算法，透過 TDX 既有的公車路線圖資（[`Bus_Shape()`](#公車路線線型資料)）與公車站牌圖資（[`Bus_StopOfRoute()`](#公車站點資料)）切分數個站牌間的區間，依此計算各區間的長度即為站點間旅行距離。由於公車站點並不一定落於公車路線上（通常不可能是），故必須先行地圖匹配（map-matching），本演算法中簡單應用 Paul Newson 與 John Krumm 所提出之先進地圖匹配法（advanced map-matching），將所有公車站牌定位至路線上，以便於拆分並計算累積里程。

### 使用資料與函式
```{r use_function, echo=T, eval=F}
library(TDX)

# TDX 套件中應用函式
Bus_Route()
Bus_Shape()
Bus_StopOfRoute()
```

### 演算概念與步驟
本演算法步驟如圖\@ref(fig:algo-step)所示。圖中綠色點為公車站牌，藍色線段為公車路線，首先將公車站牌匹配至公車路線上，並依此切分公車路線，最後計算兩站牌間的距離即可得站間旅行距離。
```{r algo-step, echo=F, eval=T, out.width="70%", fig.align="center", fig.cap="演算法步驟示意圖"}
# dir_files=dir("./figure/OD_dist", full.names=T)
# gifski::gifski(dir_files, "./figure/OD_dist.gif", width=1412, height=422, delay=1.5)
include_graphics("./figure/OD_dist.gif")
```


<span style="font-size:15pt;text-decoration:underline">**步驟一：拆分公車路線之線段**</span>  



